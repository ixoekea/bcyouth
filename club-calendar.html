<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Event Calendar with Club and Final Submit</title>
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <style>
    #eventModal, #clubModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 1rem;
      border-radius: 5px;
      width: 320px;
    }
    label {
      display: block;
      margin: 0.5rem 0 0.2rem;
    }
  </style>
</head>
<body>
  <h2>Event Calendar Form</h2>

  <input id="calendar" placeholder="Select a date" readonly disabled />

  <!-- Club Modal -->
  <div id="clubModal" style="display:flex;">
    <div class="modal-content">
      <h3>Which club are you part of?</h3>
      <form id="clubForm">
        <label>Club Name: <input type="text" name="clubName" required /></label>
        <div style="margin-top:1rem;">
          <button type="submit">Start</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Event Modal -->
  <div id="eventModal">
    <div class="modal-content">
      <h3>Add Event for <span id="selectedDateText"></span></h3>
      <form id="eventForm">
        <label>Name of Event: <input type="text" name="eventName" required /></label>
        <label>Time: <input type="text" name="eventTime" placeholder="e.g. 3:00 PM" required /></label>
        <label>
          <input type="checkbox" name="multiDay" id="multiDayCheckbox" /> Multiday Event
        </label>
        <div id="multiDayDates" style="display:none; margin-top: 0.5rem;">
          <label>Select additional dates:</label>
          <input type="text" id="additionalDatesPicker" placeholder="Select additional dates" />
        </div>
        <label>Description:<br/>
          <textarea name="description" rows="3" style="width:100%;"></textarea>
        </label>
        <label>Location: <input type="text" name="location" required /></label>
        <div style="margin-top:1rem;">
          <button type="submit">Add Event</button>
          <button type="button" id="eventCancelBtn">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <h3>Events Added:</h3>
  <ul id="eventsList"></ul>

  <button id="finalSubmitBtn" disabled>Submit All Events</button>

  <script>
    const calendarInput = document.getElementById('calendar');
    const clubModal = document.getElementById('clubModal');
    const clubForm = document.getElementById('clubForm');
    const clubCancelBtn = document.getElementById('clubCancelBtn');
    const eventModal = document.getElementById('eventModal');
    const eventForm = document.getElementById('eventForm');
    const selectedDateText = document.getElementById('selectedDateText');
    const multiDayCheckbox = document.getElementById('multiDayCheckbox');
    const multiDayDatesDiv = document.getElementById('multiDayDates');
    const additionalDatesPicker = document.getElementById('additionalDatesPicker');
    const eventsList = document.getElementById('eventsList');
    const finalSubmitBtn = document.getElementById('finalSubmitBtn');

    let additionalDatesFP = flatpickr(additionalDatesPicker, {
      mode: "multiple",
      dateFormat: "Y-m-d",
      allowInput: true,
    });

    let currentSelectedDate = null;
    let currentClubName = '';
    const eventsData = [];

    // Step 1: When user selects a date, ask for Club Name first
    flatpickr(calendarInput, {
      dateFormat: "Y-m-d",
      onChange: function(selectedDates) {
        if (selectedDates.length === 0) return;
        currentSelectedDate = selectedDates[0].toISOString().slice(0,10);
        clubModal.style.display = 'flex';
        clubForm.reset();
        calendarInput._flatpickr.clear();
      }
    });

    clubForm.onsubmit = (e) => {
      e.preventDefault();
      const clubInput = clubForm.clubName.value.trim();
      if (!clubInput) return alert('Please enter your club name.');
      currentClubName = clubInput;
      clubModal.style.display = 'none';
      openEventModal(currentSelectedDate);
    };

    clubCancelBtn.onclick = () => {
      clubModal.style.display = 'none';
    };

    function openEventModal(dateStr) {
      selectedDateText.textContent = dateStr;
      eventForm.reset();
      multiDayDatesDiv.style.display = 'none';
      additionalDatesFP.clear();
      eventModal.style.display = 'flex';
      eventForm.dataset.mainDate = dateStr;
    }

    multiDayCheckbox.addEventListener('change', () => {
      multiDayDatesDiv.style.display = multiDayCheckbox.checked ? 'block' : 'none';
      if (!multiDayCheckbox.checked) {
        additionalDatesFP.clear();
      }
    });
eventForm.onsubmit = e => {
  e.preventDefault();
  const mainDate = eventForm.dataset.mainDate;
  const eventName = eventForm.eventName.value.trim();
  const eventTime = eventForm.eventTime.value.trim();
  const isMultiDay = eventForm.multiDay.checked;
  const description = eventForm.description.value.trim();
  const location = eventForm.location.value.trim();
  const additionalDates = additionalDatesFP.selectedDates.map(d => d.toISOString().slice(0,10));

  if (!eventName || !eventTime || !location) {
    alert("Please fill in all required fields.");
    return;
  }

  const allDates = [mainDate];
  if (isMultiDay) {
    additionalDates.forEach(d => {
      if (!allDates.includes(d)) allDates.push(d);
    });
  }

  eventsData.push({
    club: currentClubName,
    eventName,
    eventTime,
    description,
    location,
    dates: allDates
  });

  allDates.forEach(date => {
    const li = document.createElement('li');
    li.textContent = `[${currentClubName}] ${date} - ${eventName} at ${eventTime}, Location: ${location}`;
    if(description) li.textContent += `, Description: ${description}`;
    eventsList.appendChild(li);
  });

  finalSubmitBtn.disabled = false;
  eventModal.style.display = 'none';

  // Clear calendar input so user can pick another date
  calendarInput._flatpickr.clear();
};

    document.getElementById('eventCancelBtn').onclick = () => {
      eventModal.style.display = 'none';
    };

    // Close modals if clicked outside content
    [clubModal, eventModal].forEach(modal => {
      modal.addEventListener('click', (e) => {
        if(e.target === modal) modal.style.display = 'none';
      });
    });

    // Final submit button: send all events to Google Apps Script
    finalSubmitBtn.onclick = () => {
      if(eventsData.length === 0) {
        alert("No events to submit.");
        return;
      }

      finalSubmitBtn.disabled = true;

      // Prepare FormData
      const formData = new FormData();
      formData.append("events", JSON.stringify(eventsData));

      fetch('https://script.google.com/macros/s/AKfycbz5AGhioEFs6L2bUPXeKG1VoJR7hfiygwUzCrFL0HZ-qDbZvAof7fSJnTd1nT0Y7R9G/exec', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        alert(data.message || 'Events submitted successfully!');
        eventsData.length = 0; // clear array
        eventsList.innerHTML = '';
        finalSubmitBtn.disabled = true;
      })
      .catch(err => {
        alert("Submission failed: " + err.message);
        finalSubmitBtn.disabled = false;
      });
    };
  </script>
</body>
</html>
