<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Club Event Calendar</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        margin: 0;
        background: #f5f6fa;
      }
      #nav-placeholder a.active {
        font-weight: bold;
        text-decoration: underline;
      }
      main {
        padding: 2rem;
        display: flex;
        justify-content: center;
      }
      .form-container {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        max-width: 700px;
        width: 100%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }
      label {
        display: block;
        margin: 1rem 0 0.5rem;
      }
      input,
      select,
      textarea {
        padding: 0.5rem;
        margin-top: 0.25rem;
        border-radius: 6px;
        border: 1px solid #ccc;
        width: 100%;
      }
      button {
        margin-top: 1rem;
        padding: 0.5rem 1rem;
        background-color: #3f51b5;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      button:hover {
        background-color: #303f9f;
      }
      #eventModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .modal-content {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        width: 320px;
      }
      ul#eventsList {
        margin-top: 1rem;
      }
      #clubSelect:disabled {
        background: #eee;
      }
    </style>
  </head>
  <body>
    <div id="nav-placeholder"></div>

    <main>
      <div class="form-container">
        <!-- Main Calendar Form -->
        <form
          id="calendarForm"
          action="https://script.google.com/macros/s/AKfycbz5AGhioEFs6L2bUPXeKG1VoJR7hfiygwUzCrFL0HZ-qDbZvAof7fSJnTd1nT0Y7R9G/exec"
          method="post"
          target="hidden_iframe"
        >
          <!-- Club Type -->
          <fieldset>
            <legend>Club Type</legend>
            <label>
              <input type="radio" name="clubType" value="Adventurer" required />
              Adventurer Club
            </label>
            <label>
              <input type="radio" name="clubType" value="Pathfinder" />
              Pathfinder Club
            </label>
          </fieldset>

          <!-- Club Selection -->
          <label>
            Select Club:
            <select name="club" id="clubSelect" required disabled>
              <option value="">-- Select your club --</option>
            </select>
          </label>

          <!-- Calendar Input -->
          <label for="calendarInput">Click a date to add an event:</label>
          <input
            id="calendarInput"
            type="text"
            placeholder="Pick a date"
            readonly
          />

          <h3>Events Added:</h3>
          <ul id="eventsList"></ul>

          <!-- Hidden Inputs for Apps Script -->
          <input type="hidden" name="events" id="eventsInput" />
          <label>
            Calendar Approved:
            <select name="calendarApproved" id="calendarApprovedSelect">
              <option value="Not Verified">Not Verified</option>
              <option value="Verified">Verified</option>
            </select>
          </label>
          <label class="calendarDateLabel" style="display: none">
            Calendar Board Approval Date:
            <input
              type="date"
              name="boardApprovalDate"
              id="boardApprovalDateInput"
              disabled
            />
          </label>

          <button type="submit">Submit All Events</button>
        </form>
      </div>
    </main>

    <!-- Event Modal (outside main form!) -->
    <div id="eventModal">
      <div class="modal-content">
        <form id="eventForm">
          <h3>Add Event for <span id="selectedDateText"></span></h3>
          <label>
            Event Type:
            <select id="eventTypeSelect" required>
              <option value="" disabled selected>Select an event type</option>
              <option value="Induction">Induction</option>
              <option value="Youth Summit">Youth Summit</option>
              <option value="Community Service">Community Service</option>
              <option value="Pathfinder/Adventurer Sabbath">
                Pathfinder/Adventurer Sabbath
              </option>
              <option value="Camporee">Camporee</option>
              <option value="Investiture">Investiture</option>
              <option value="Meetings">Meetings</option>
              <option value="Other">Other</option>
            </select>
          </label>
          <label id="customEventTypeLabel" style="display: none">
            Custom Event Type:
            <input type="text" id="customEventTypeInput" />
          </label>
          <label>
            Time:
            <input
              type="text"
              name="eventTime"
              placeholder="e.g. 3:00 PM"
              required
            />
          </label>
          <label>
            <input type="checkbox" name="multiDay" id="multiDayCheckbox" />
            Multiday Event
          </label>
          <div id="multiDayDates" style="display: none; margin-top: 0.5rem">
            <label>Select additional dates:</label>
            <input
              type="text"
              id="additionalDatesPicker"
              placeholder="Select additional dates"
            />
          </div>
          <label>
            Description:<br />
            <textarea name="description" rows="3"></textarea>
          </label>
          <label>
            Location: <input type="text" name="location" required />
          </label>
          <div style="margin-top: 1rem">
            <button type="submit">Add Event</button>
            <button type="button" id="eventCancelBtn">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <iframe name="hidden_iframe" style="display: none"></iframe>

    <script>
      // ------------------------------
      // Clubs
      // ------------------------------
      const clubs = {
        Adventurer: [
          "`Lil Titans",
          "Agape Lynx",
          "Cariboo Gold",
          "Creekside Jr. Falcons",
          "Dawson Creek Peacemakers",
          "Heavenbound",
          "Inspire-Burnaby",
          "Island Eaglets",
          "Kelowna Silver Paws",
          "Lake City",
          "Lakeside",
          "Mighty Islanders",
          "Mount Cheam",
          "Northern Lightbearers",
          "Orion",
          "Radical Rabbits",
          "Sooke Sea Stars",
          "Surrey Beavers",
          "Surrey Dolphins",
          "The Kamloops Eagle",
          "Vancouver Rangerz",
          "Westminster Thunderbirds",
          "White Rock Otters",
        ],
        Pathfinder: [
          "Agape Lynx",
          "Cariboo Gold",
          "Creekside Falcons",
          "Dawson Creek Peacemakers",
          "EBENEZER",
          "Fraser Valley Titans",
          "Fraserview",
          "Golden Eagles",
          "Inspire Jaguars",
          "Island Eagles",
          "Island Explorers",
          "Lake City",
          "Mount Cheam",
          "OAC Bears",
          "Peacelanders",
          "PG Nighthawks",
          "Richmond Ravens",
          "Sardis Spirits",
          "Shuswap Eagles",
          "Silver Tip",
          "Surrey Beavers",
          "SURREY TIGERS",
          "Westminster Thunderbirds",
        ],
      };

      // ------------------------------
      // Populate Club select
      // ------------------------------
      document.querySelectorAll('input[name="clubType"]').forEach((radio) => {
        radio.addEventListener("change", () => {
          const select = document.getElementById("clubSelect");
          select.innerHTML = '<option value="">-- Select your club --</option>';
          clubs[radio.value].forEach((name) => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            select.appendChild(opt);
          });
          select.disabled = false;
        });
      });

      // ------------------------------
      // Calendar Approval Toggle
      // ------------------------------
      const calendarApprovedSelect = document.getElementById(
        "calendarApprovedSelect",
      );
      const boardApprovalDateInput = document.getElementById(
        "boardApprovalDateInput",
      );
      calendarApprovedSelect.addEventListener("change", () => {
        const show = calendarApprovedSelect.value === "Verified";
        boardApprovalDateInput.disabled = !show;
        boardApprovalDateInput.parentElement.style.display = show
          ? "block"
          : "none";
      });

      // ------------------------------
      // Event Modal Logic
      // ------------------------------
      let eventsData = [];
      const calendarInput = document.getElementById("calendarInput");
      const eventModal = document.getElementById("eventModal");
      const eventForm = document.getElementById("eventForm");
      const selectedDateText = document.getElementById("selectedDateText");
      const multiDayCheckbox = document.getElementById("multiDayCheckbox");
      const multiDayDatesDiv = document.getElementById("multiDayDates");
      const additionalDatesPicker = document.getElementById(
        "additionalDatesPicker",
      );
      const eventsList = document.getElementById("eventsList");
      const eventsInput = document.getElementById("eventsInput");
      const customEventTypeLabel = document.getElementById(
        "customEventTypeLabel",
      );
      const customEventTypeInput = document.getElementById(
        "customEventTypeInput",
      );

      // Flatpickr for additional dates
      let additionalDatesFP = flatpickr(additionalDatesPicker, {
        mode: "multiple",
        dateFormat: "Y-m-d",
        allowInput: true,
      });

      // Flatpickr for main calendar input
      flatpickr(calendarInput, {
        dateFormat: "Y-m-d",
        disableMobile: true,
        onChange: function (dates) {
          if (!dates.length) return;
          openEventModal(dates[0].toISOString().slice(0, 10));
        },
      });

      function openEventModal(dateStr) {
        selectedDateText.textContent = dateStr;
        eventForm.reset();
        multiDayDatesDiv.style.display = multiDayCheckbox.checked
          ? "block"
          : "none";

        if (multiDayCheckbox.checked) {
          additionalDatesFP.setDate([dateStr]);
        } else {
          additionalDatesFP.clear();
        }

        customEventTypeLabel.style.display = "none";
        eventModal.style.display = "flex"; // SHOW modal
        eventForm.dataset.mainDate = dateStr;
      }

      // Multi-day checkbox toggle
      multiDayCheckbox.addEventListener("change", () => {
        multiDayDatesDiv.style.display = multiDayCheckbox.checked
          ? "block"
          : "none";
        if (!multiDayCheckbox.checked) additionalDatesFP.clear();
      });

      // Cancel modal
      document.getElementById("eventCancelBtn").onclick = () =>
        (eventModal.style.display = "none");
      eventModal.addEventListener("click", (e) => {
        if (e.target === eventModal) eventModal.style.display = "none";
      });

      // Custom event type input
      document
        .getElementById("eventTypeSelect")
        .addEventListener("change", () => {
          customEventTypeLabel.style.display =
            document.getElementById("eventTypeSelect").value === "Other"
              ? "block"
              : "none";
        });

      // Submit event
      eventForm.onsubmit = (e) => {
        e.preventDefault();
        const mainDate = eventForm.dataset.mainDate;
        const selectedType = document.getElementById("eventTypeSelect").value;
        const eventType =
          selectedType === "Other"
            ? customEventTypeInput.value.trim()
            : selectedType;
        const eventTime = eventForm.eventTime.value.trim();
        const description = eventForm.description.value.trim();
        const location = eventForm.location.value.trim();
        const additionalDates = additionalDatesFP.selectedDates.map((d) =>
          d.toISOString().slice(0, 10),
        );
        const allDates = [
          mainDate,
          ...additionalDates.filter((d) => d !== mainDate),
        ];

        if (!eventType || !eventTime || !location) {
          alert("Please fill all required fields");
          return;
        }

        const entry = {
          club: document.getElementById("clubSelect").value,
          eventType,
          eventTime,
          description,
          location,
          dates: allDates,
        };
        eventsData.push(entry);

        allDates.forEach((date) => {
          const li = document.createElement("li");
          li.textContent =
            `[${entry.club}] ${date} - ${eventType} at ${eventTime}, Location: ${location}` +
            (description ? `, Description: ${description}` : "");

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "ðŸ—‘ï¸ Delete";
          deleteBtn.style.marginLeft = "10px";
          deleteBtn.onclick = () => {
            eventsData = eventsData.filter((ev) => ev !== entry);
            eventsList.removeChild(li);
            eventsInput.value = JSON.stringify(eventsData);
          };
          li.appendChild(deleteBtn);
          eventsList.appendChild(li);
        });

        eventsInput.value = JSON.stringify(eventsData);
        eventModal.style.display = "none";
      };

      // ------------------------------
      // Load nav
      // ------------------------------
      fetch("nav.html")
        .then((r) => r.text())
        .then((html) => {
          document.getElementById("nav-placeholder").innerHTML = html;
          const current = location.pathname.split("/").pop();
          document.querySelectorAll("#nav-placeholder a").forEach((a) => {
            if (a.getAttribute("href") === current) a.classList.add("active");
          });
        });
    </script>
  </body>
</html>
