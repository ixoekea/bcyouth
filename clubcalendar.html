<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Club Event Calendar</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        margin: 0;
        background: #f5f6fa;
      }
      main {
        padding: 2rem;
        display: flex;
        justify-content: center;
      }
      .form-container {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        max-width: 700px;
        width: 100%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }
      label {
        display: block;
        margin: 1rem 0 0.5rem;
      }
      input,
      select,
      textarea {
        padding: 0.5rem;
        margin-top: 0.25rem;
        border-radius: 6px;
        border: 1px solid #ccc;
        width: 100%;
      }
      button {
        margin-top: 1rem;
        padding: 0.5rem 1rem;
        background-color: #3f51b5;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      button:hover:not(:disabled) {
        background-color: #303f9f;
      }
      button:disabled {
        background-color: #999;
        cursor: not-allowed;
      }
      #eventModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 99999;
      }
      .modal-content {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        width: 320px;
      }
      ul#eventsList {
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
    <main>
      <div class="form-container">
        <form
          id="calendarForm"
          action="https://script.google.com/macros/s/AKfycbz5AGhioEFs6L2bUPXeKG1VoJR7hfiygwUzCrFL0HZ-qDbZvAof7fSJnTd1nT0Y7R9G/exec"
          method="post"
          target="hidden_iframe"
        >
          <!-- Club Type -->
          <fieldset>
            <legend>Club Type</legend>
            <label
              ><input
                type="radio"
                name="clubType"
                value="Adventurer"
                required
              />
              Adventurer Club</label
            >
            <label
              ><input type="radio" name="clubType" value="Pathfinder" />
              Pathfinder Club</label
            >
          </fieldset>

          <!-- Club Selection -->
          <label>
            Select Club:
            <select name="club" id="clubSelect" required disabled>
              <option value="">-- Select your club --</option>
            </select>
          </label>

          <!-- Calendar Input -->
          <label for="calendarInput">Click a date to add an event:</label>
          <input
            id="calendarInput"
            type="text"
            placeholder="Pick a date"
            readonly
          />

          <h3>Events Added:</h3>
          <ul id="eventsList"></ul>

          <!-- Hidden Inputs -->
          <input type="hidden" name="events" id="eventsInput" />
          <label>
            Calendar Approved:
            <select name="calendarApproved" id="calendarApprovedSelect">
              <option value="Not Verified">Not Verified</option>
              <option value="Verified">Verified</option>
            </select>
          </label>
          <label class="calendarDateLabel" style="display: none">
            Calendar Board Approval Date:
            <input
              type="date"
              name="boardApprovalDate"
              id="boardApprovalDateInput"
              disabled
            />
          </label>

          <!-- Submit -->
          <button type="submit" id="submitBtn">Submit All Events</button>
          <span
            id="successMessage"
            style="display: none; color: green; margin-left: 10px"
            >Successfully submitted!</span
          >
        </form>
      </div>
    </main>

    <!-- Event Modal (outside form) -->
    <div id="eventModal">
      <div class="modal-content">
        <form id="eventForm">
          <h3>Add Event for <span id="selectedDateText"></span></h3>
          <label>
            Event Type:
            <select id="eventTypeSelect" required>
              <option value="" disabled selected>Select an event type</option>
              <option value="Induction">Induction</option>
              <option value="Youth Summit">Youth Summit</option>
              <option value="Community Service">Community Service</option>
              <option value="Pathfinder/Adventurer Sabbath">
                Pathfinder/Adventurer Sabbath
              </option>
              <option value="Camporee">Camporee</option>
              <option value="Investiture">Investiture</option>
              <option value="Meetings">Meetings</option>
              <option value="Other">Other</option>
            </select>
          </label>
          <label id="customEventTypeLabel" style="display: none">
            Custom Event Type: <input type="text" id="customEventTypeInput" />
          </label>
          <label
            >Time:
            <input
              type="text"
              name="eventTime"
              placeholder="e.g. 3:00 PM"
              required
          /></label>
          <label
            ><input type="checkbox" id="multiDayCheckbox" /> Multiday
            Event</label
          >
          <div id="multiDayDates" style="display: none; margin-top: 0.5rem">
            <label>Select additional dates:</label>
            <input
              type="text"
              id="additionalDatesPicker"
              placeholder="Select additional dates"
            />
          </div>
          <label
            >Description:<br /><textarea name="description" rows="3"></textarea>
          </label>
          <label
            >Location: <input type="text" name="location" required
          /></label>
          <div style="margin-top: 1rem">
            <button type="submit">Add Event</button>
            <button type="button" id="eventCancelBtn">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <iframe name="hidden_iframe" style="display: none"></iframe>

    <script>
      // ------------------------------
      // Club dropdown logic
      // ------------------------------
      const clubs = {
        Adventurer: [
          { id: "A01", name: "`LIL TITANS" },
          { id: "A02", name: "Agape Lynx" },
          { id: "A03", name: "Cariboo Gold" },
          { id: "A03", name: "Chickadee" },
          { id: "A03", name: "Cranbrook SDA Church" },
          { id: "A04", name: "Creekside Jr. Falcons" },
          { id: "A05", name: "Dawson Creek Peacemakers" },
          { id: "A06", name: "Heavenbound" },
          { id: "A07", name: "Inspire-Burnaby" },
          { id: "A08", name: "Island Eaglets" },
          { id: "P09", name: "Island Explorers" },
          { id: "A10", name: "Kelowna Silver Paws" },
          { id: "A11", name: "Lake City" },
          { id: "A12", name: "Lakeside" },
          { id: "A13", name: "Mighty Islanders" },
          { id: "A14", name: "Mount Cheam" },
          { id: "A15", name: "Northern Lightbearers" },
          { id: "A16", name: "Orion" },
          { id: "P17", name: "Penticton SDA Spirit Bears" },
          { id: "A18", name: "Radical Rabbits" },
          { id: "P19", name: "Robson Peaks" },
          { id: "A20", name: "Sooke Sea Stars" },
          { id: "A21", name: "Surrey Beavers" },
          { id: "A22", name: "Surrey Dolphins" },
          { id: "A23", name: "The Kamloops Eagle" },
          { id: "A24", name: "Vancouver Rangerz" },
          { id: "A25", name: "Westminster Thunderbirds" },
          { id: "A26", name: "White Rock Otters" },
        ],
        Pathfinder: [
          { id: "P01", name: "Agape Lynx" },
          { id: "P02", name: "Cariboo Gold" },
          { id: "P03", name: "Cranbrook SDA Church" },
          { id: "P04", name: "Creekside Falcons" },
          { id: "P05", name: "Dawson Creek Peacemakers" },
          { id: "P06", name: "EBENEZER" },
          { id: "P07", name: "Fraser Valley Titans" },
          { id: "P08", name: "Fraserview" },
          { id: "P09", name: "Golden Eagles" },
          { id: "P10", name: "Inspire Jaguars" },
          { id: "P11", name: "Island Eagles" },
          { id: "P12", name: "Island Explorers" },
          { id: "P13", name: "Lake City" },
          { id: "P14", name: "Mount Cheam" },
          { id: "P15", name: "OAC Bears" },
          { id: "P16", name: "Peacelanders" },
          { id: "P17", name: "PG Nighthawks" },
          { id: "P18", name: "Richmond Ravens" },
          { id: "P19", name: "Robson Peaks" },
          { id: "P20", name: "Sardis Spirits" },
          { id: "P21", name: "Shuswap Eagles" },
          { id: "P22", name: "Silver Tip" },
          { id: "P23", name: "Skyhawks" },
          { id: "P24", name: "Surrey Beavers" },
          { id: "P25", name: "SURREY TIGERS" },
          { id: "P26", name: "Westminster Thunderbirds" },
        ],
      };

      // Populate club dropdown
      document.querySelectorAll('input[name="clubType"]').forEach((radio) => {
        radio.addEventListener("change", () => {
          const select = document.getElementById("clubSelect");
          select.innerHTML = '<option value="">-- Select your club --</option>';
          clubs[radio.value].forEach((club) => {
            const opt = document.createElement("option");
            opt.value = club.id; // ID will be sent on form submission
            opt.textContent = club.name; // Name shown in dropdown
            select.appendChild(opt);
          });
          select.disabled = false;
        });
      });

      // Calendar approval toggle
      const calendarApprovedSelect = document.getElementById(
        "calendarApprovedSelect",
      );
      const boardApprovalDateInput = document.getElementById(
        "boardApprovalDateInput",
      );
      calendarApprovedSelect.addEventListener("change", () => {
        const show = calendarApprovedSelect.value === "Verified";
        boardApprovalDateInput.disabled = !show;
        boardApprovalDateInput.parentElement.style.display = show
          ? "block"
          : "none";
      });

      // ------------------------------
      // Event modal logic
      // ------------------------------
      let eventsData = [];
      const calendarInput = document.getElementById("calendarInput");
      const eventModal = document.getElementById("eventModal");
      const eventForm = document.getElementById("eventForm");
      const selectedDateText = document.getElementById("selectedDateText");
      const multiDayCheckbox = document.getElementById("multiDayCheckbox");
      const multiDayDatesDiv = document.getElementById("multiDayDates");
      const additionalDatesPicker = document.getElementById(
        "additionalDatesPicker",
      );
      const eventsList = document.getElementById("eventsList");
      const eventsInput = document.getElementById("eventsInput");
      const customEventTypeLabel = document.getElementById(
        "customEventTypeLabel",
      );
      const customEventTypeInput = document.getElementById(
        "customEventTypeInput",
      );

      let additionalDatesFP = flatpickr(additionalDatesPicker, {
        mode: "multiple",
        dateFormat: "Y-m-d",
        allowInput: true,
      });
      flatpickr(calendarInput, {
        dateFormat: "Y-m-d",
        disableMobile: true,
        onChange: (dates) => {
          if (dates.length) openEventModal(dates[0].toISOString().slice(0, 10));
        },
      });

      function openEventModal(dateStr) {
        selectedDateText.textContent = dateStr;
        eventForm.reset();
        multiDayDatesDiv.style.display = multiDayCheckbox.checked
          ? "block"
          : "none";
        if (multiDayCheckbox.checked) additionalDatesFP.setDate([dateStr]);
        else additionalDatesFP.clear();
        customEventTypeLabel.style.display = "none";
        eventModal.style.display = "flex";
        eventForm.dataset.mainDate = dateStr;
      }

      multiDayCheckbox.addEventListener("change", () => {
        multiDayDatesDiv.style.display = multiDayCheckbox.checked
          ? "block"
          : "none";
        if (!multiDayCheckbox.checked) additionalDatesFP.clear();
      });
      document.getElementById("eventCancelBtn").onclick = () =>
        (eventModal.style.display = "none");
      eventModal.addEventListener("click", (e) => {
        if (e.target === eventModal) eventModal.style.display = "none";
      });
      document
        .getElementById("eventTypeSelect")
        .addEventListener("change", () => {
          customEventTypeLabel.style.display =
            document.getElementById("eventTypeSelect").value === "Other"
              ? "block"
              : "none";
        });

      eventForm.onsubmit = (e) => {
        e.preventDefault();
        const mainDate = eventForm.dataset.mainDate;
        const selectedType = document.getElementById("eventTypeSelect").value;
        const eventType =
          selectedType === "Other"
            ? customEventTypeInput.value.trim()
            : selectedType;
        const eventTime = eventForm.eventTime.value.trim();
        const description = eventForm.description.value.trim();
        const location = eventForm.location.value.trim();
        const additionalDates = additionalDatesFP.selectedDates.map((d) =>
          d.toISOString().slice(0, 10),
        );
        const allDates = [
          mainDate,
          ...additionalDates.filter((d) => d !== mainDate),
        ];
        if (!eventType || !eventTime || !location) {
          alert("Please fill all required fields");
          return;
        }
        const entry = {
          club: document.getElementById("clubSelect").value,
          eventType,
          eventTime,
          description,
          location,
          dates: allDates,
        };
        eventsData.push(entry);
        allDates.forEach((date) => {
          const li = document.createElement("li");
          li.textContent =
            `[${entry.club}] ${date} - ${eventType} at ${eventTime}, Location: ${location}` +
            (description ? `, Description: ${description}` : "");
          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "ðŸ—‘ï¸ Delete";
          deleteBtn.style.marginLeft = "10px";
          deleteBtn.onclick = () => {
            eventsData = eventsData.filter((ev) => ev !== entry);
            eventsList.removeChild(li);
            eventsInput.value = JSON.stringify(eventsData);
          };
          li.appendChild(deleteBtn);
          eventsList.appendChild(li);
        });
        eventsInput.value = JSON.stringify(eventsData);
        eventModal.style.display = "none";
      };

      // ------------------------------
      // Form submission with submit button disabled + success message
      // ------------------------------
      const calendarForm = document.getElementById("calendarForm");
      const submitBtn = document.getElementById("submitBtn");
      const successMessage = document.getElementById("successMessage");
      const hiddenIframe = document.querySelector(
        'iframe[name="hidden_iframe"]',
      );
      let isSubmitting = false;

      calendarForm.addEventListener("submit", (e) => {
        e.preventDefault();
        if (isSubmitting) return;
        isSubmitting = true;
        submitBtn.disabled = true;
        submitBtn.textContent = "Submitting...";
        successMessage.style.display = "none";

        const onIframeLoad = () => {
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit All Events";
          successMessage.style.display = "inline-block";
          isSubmitting = false;
          hiddenIframe.removeEventListener("load", onIframeLoad);
        };
        hiddenIframe.addEventListener("load", onIframeLoad);
        calendarForm.submit();
      });
    </script>
  </body>
</html>
