<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>BC Club Staff Registration</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        margin: 0;
        background: #f5f6fa;
      }
      main {
        padding: 2rem;
        display: flex;
        justify-content: center;
      }
      .form-container {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        max-width: 1000px;
        width: 100%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }
      label {
        display: block;
        margin: 1rem 0 0.5rem;
      }
      input,
      select,
      button {
        padding: 0.5rem;
        border-radius: 6px;
        border: 1px solid #ccc;
        width: 100%;
      }
      button {
        margin-top: 1rem;
        background: #3f51b5;
        color: white;
        border: none;
        cursor: pointer;
      }
      button:hover {
        background: #303f9f;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }
      th,
      td {
        padding: 0.5rem;
        border: 1px solid #ccc;
        text-align: left;
      }
      th {
        background: #f0f0f0;
      }
    </style>
  </head>
  <body>
    <main>
      <div class="form-container">
        <h2>Staff Registration</h2>

        <label
          >Club Type:
          <select id="clubType">
            <option value="">-- Select Club Type --</option>
            <option value="Adventurer">Adventurer</option>
            <option value="Pathfinder">Pathfinder</option>
          </select>
        </label>

        <label
          >Club Name:
          <select id="clubSelect" disabled>
            <option value="">-- Select Club --</option>
          </select>
        </label>

        <label>Email: <input type="email" id="email" required /></label>
        <label
          >Access Code: <input type="text" id="accessCode" required
        /></label>
        <button type="button" id="loadStaff">Load Staff</button>

        <div id="staffContainer" style="display: none">
          <table id="staffTable">
            <thead></thead>
            <tbody></tbody>
          </table>

          <h3>Add New Staff</h3>
          <label>Name: <input type="text" id="newName" /></label>
          <label>Email: <input type="email" id="newEmail" /></label>
          <button type="button" id="addStaff">Add Staff</button>
          <button type="button" id="submitStaff">Submit All Changes</button>
        </div>
      </div>
    </main>

    <script>
      const WEB_APP_URL =
        "https://script.google.com/macros/s/AKfycbzzc8jZFtIoTiP5Mztcssf09c1rxI95MPMBNRp6qWrNmgwH0MwQNAPy1Gk2pzXEFklpgg/exec";

      const clubs = {
        Adventurer: [
          "`Lil Titans",
          "Agape Lynx",
          "Cariboo Gold",
          "Creekside Jr. Falcons",
          "Dawson Creek Peacemakers",
          "Heavenbound",
          "Inspire-Burnaby",
          "Island Eaglets",
          "Kelowna Silver Paws",
          "Lake City",
          "Lakeside",
          "Mighty Islanders",
          "Mount Cheam",
          "Northern Lightbearers",
          "Orion",
          "Radical Rabbits",
          "Sooke Sea Stars",
          "Surrey Beavers",
          "Surrey Dolphins",
          "The Kamloops Eagle",
          "Vancouver Rangerz",
          "Westminster Thunderbirds",
          "White Rock Otters",
        ],
        Pathfinder: [
          "Agape Lynx",
          "Cariboo Gold",
          "Creekside Falcons",
          "Dawson Creek Peacemakers",
          "EBENEZER",
          "Fraser Valley Titans",
          "Fraserview",
          "Golden Eagles",
          "Inspire Jaguars",
          "Island Eagles",
          "Island Explorers",
          "Lake City",
          "Mount Cheam",
          "OAC Bears",
          "Peacelanders",
          "PG Nighthawks",
          "Richmond Ravens",
          "Sardis Spirits",
          "Shuswap Eagles",
          "Silver Tip",
          "Surrey Beavers",
          "SURREY TIGERS",
          "Westminster Thunderbirds",
        ],
      };

      let staffList = [];
      let staffHeaders = [];

      // Populate club dropdown
      document
        .getElementById("clubType")
        .addEventListener("change", function () {
          const type = this.value;
          const select = document.getElementById("clubSelect");
          select.innerHTML = '<option value="">-- Select Club --</option>';
          if (type) {
            clubs[type].forEach((c) => {
              const opt = document.createElement("option");
              opt.value = c;
              opt.textContent = c;
              select.appendChild(opt);
            });
            select.disabled = false;
          } else select.disabled = true;
        });

      // Load staff
      document.getElementById("loadStaff").addEventListener("click", loadStaff);

      async function loadStaff() {
        const club = document.getElementById("clubSelect").value;
        const clubType = document.getElementById("clubType").value;
        const email = document.getElementById("email").value.trim();
        const accessCode = document.getElementById("accessCode").value.trim();
        if (!club || !clubType || !email || !accessCode) {
          alert("Please fill all fields for verification.");
          return;
        }
        try {
          const res = await fetch(WEB_APP_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "load",
              club,
              clubType,
              email,
              accessCode,
            }),
          });
          const data = await res.json();
          if (!data.length) {
            alert("No staff found or verification failed.");
            return;
          }
          staffList = data;
          staffHeaders = Object.keys(staffList[0]).filter(
            (h) => h !== "rowNumber",
          );
          renderStaffTable();
          document.getElementById("staffContainer").style.display = "block";
        } catch (err) {
          console.error(err);
          alert("Error loading staff");
        }
      }

      // Render table
      function renderStaffTable() {
        const tbody = document.querySelector("#staffTable tbody");
        tbody.innerHTML = "";
        const thead = document.querySelector("#staffTable thead");
        thead.innerHTML = "";

        // Table headers
        const trHead = document.createElement("tr");
        staffHeaders.forEach((h) => {
          const th = document.createElement("th");
          th.textContent = h;
          trHead.appendChild(th);
        });
        const thDel = document.createElement("th");
        thDel.textContent = "Delete";
        trHead.appendChild(thDel);
        thead.appendChild(trHead);

        staffList.forEach((staff, i) => {
          const tr = document.createElement("tr");
          staffHeaders.forEach((f) => {
            const td = document.createElement("td");
            if (f === "Volunteer Form Submitted" || f === "Over 19+") {
              const input = document.createElement("input");
              input.type = "checkbox";
              input.checked = staff[f] === "Yes";
              input.dataset.index = i;
              input.dataset.field = f;
              td.appendChild(input);
            } else if (staff[f] === "Yes" || staff[f] === "No") {
              const sel = document.createElement("select");
              ["Yes", "No"].forEach((v) => {
                const opt = document.createElement("option");
                opt.value = v;
                opt.textContent = v;
                if (staff[f] === v) opt.selected = true;
                sel.appendChild(opt);
              });
              sel.dataset.index = i;
              sel.dataset.field = f;
              td.appendChild(sel);
            } else {
              const input = document.createElement("input");
              input.type = f.toLowerCase().includes("email") ? "email" : "text";
              input.value = staff[f] || "";
              input.dataset.index = i;
              input.dataset.field = f;
              td.appendChild(input);
            }
            tr.appendChild(td);
          });
          const tdDel = document.createElement("td");
          const delBtn = document.createElement("button");
          delBtn.textContent = "Delete";
          delBtn.onclick = () => deleteStaff(i);
          tdDel.appendChild(delBtn);
          tr.appendChild(tdDel);
          tbody.appendChild(tr);
        });
      }

      function deleteStaff(i) {
        if (confirm("Delete this staff?")) {
          staffList.splice(i, 1);
          renderStaffTable();
        }
      }

      // Add new staff
      document.getElementById("addStaff").addEventListener("click", () => {
        const name = document.getElementById("newName").value.trim();
        const email = document.getElementById("newEmail").value.trim();
        if (!name || !email) {
          alert("Enter name and email");
          return;
        }
        const newStaff = { rowNumber: null };
        staffHeaders.forEach((h) => (newStaff[h] = ""));
        newStaff["Name"] = name;
        newStaff["Email"] = email;
        staffList.push(newStaff);
        renderStaffTable();
        document.getElementById("newName").value = "";
        document.getElementById("newEmail").value = "";
      });

      // Submit all changes
      document
        .getElementById("submitStaff")
        .addEventListener("click", async () => {
          const club = document.getElementById("clubSelect").value;
          const clubType = document.getElementById("clubType").value;

          // update staffList from table inputs
          document.querySelectorAll("#staffTable tbody tr").forEach((tr) => {
            tr.querySelectorAll("input, select").forEach((input) => {
              const i = input.dataset.index;
              const f = input.dataset.field;
              if (input.type === "checkbox")
                staffList[i][f] = input.checked ? "Yes" : "No";
              else staffList[i][f] = input.value;
            });
          });

          try {
            await fetch(WEB_APP_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                action: "submit",
                club,
                clubType,
                staffList,
              }),
            });
            alert("Staff saved successfully!");
          } catch (err) {
            console.error(err);
            alert("Error submitting staff");
          }
        });
    </script>
  </body>
</html>
